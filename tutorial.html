<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tutorial - Modus Documentation</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="tutorial.html" class="active"><strong aria-hidden="true">2.</strong> Tutorial</a></li><li class="chapter-item expanded "><a href="syntax.html"><strong aria-hidden="true">3.</strong> Syntax</a></li><li class="chapter-item expanded "><a href="semantics.html"><strong aria-hidden="true">4.</strong> Semantics</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Library</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/predicates/index.html"><strong aria-hidden="true">5.1.</strong> Predicates</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/predicates/image.html"><strong aria-hidden="true">5.1.1.</strong> Image</a></li><li class="chapter-item expanded "><a href="library/predicates/layer.html"><strong aria-hidden="true">5.1.2.</strong> Layer</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.3.</strong> Logic</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/predicates/logic/number.html"><strong aria-hidden="true">5.1.3.1.</strong> Number</a></li><li class="chapter-item expanded "><a href="library/predicates/logic/string.html"><strong aria-hidden="true">5.1.3.2.</strong> String</a></li><li class="chapter-item expanded "><a href="library/predicates/logic/semver.html"><strong aria-hidden="true">5.1.3.3.</strong> SemVer</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="library/operators/index.html"><strong aria-hidden="true">5.2.</strong> Operators</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/operators/image.html"><strong aria-hidden="true">5.2.1.</strong> Image</a></li><li class="chapter-item expanded "><a href="library/operators/layer.html"><strong aria-hidden="true">5.2.2.</strong> Layer</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="foundations.html"><strong aria-hidden="true">6.</strong> Foundations</a></li><li class="chapter-item expanded "><a href="cli/index.html"><strong aria-hidden="true">7.</strong> Command Line Tool</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Modus Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/modus-continens/modus" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tutorial"><a class="header" href="#tutorial">Tutorial</a></h1>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>You can install Modus from crates.io:</p>
<pre><code>cargo install modus
</code></pre>
<p>Currently, Modus is only available on Linux, and only officially supports x86_64<sup class="footnote-reference"><a href="#x86_why">1</a></sup>.</p>
<p>You can also build Modus from source by cloning <a href="https://github.com/modus-continens/modus">the repository</a> and running <code>cargo build</code>.</p>
<h2 id="your-first-modusfile"><a class="header" href="#your-first-modusfile">Your First Modusfile</a></h2>
<p>Modusfiles are our version of Dockerfiles. They are a collection of rules that specify how to build images. We now demostrate how to use Modus to build a simple rust application.</p>
<pre><code class="language-Modusfile">my_app(profile) :-
  (
    from(&quot;rust:alpine&quot;)::set_workdir(&quot;/usr/src/app&quot;),   # FROM rust:alpine; WORKDIR /usr/src/app
    copy(&quot;.&quot;, &quot;.&quot;),                                     # COPY . .
    cargo_build(profile)                                # calling into another predicate
  )::set_entrypoint(f&quot;./target/${profile}/my_app&quot;).     # ENTRYPOINT [&quot;./target/release/my_app&quot;]

cargo_build(&quot;debug&quot;) :- run(&quot;cargo build&quot;).             # RUN cargo build
cargo_build(&quot;release&quot;) :- run(&quot;cargo build --release&quot;). # RUN cargo build --release
</code></pre>
<p>Assuming that you are familiar with Dockerfiles, the meaning of the above Modusfile should be mostly easy to guess. In particular:</p>
<ul>
<li>
<p>The syntax is an extension of <a href="https://en.wikipedia.org/wiki/Datalog">Datalog</a> (which is itself a subset of Prolog), but you do not need to know either of those languages to write your own Modusfile.</p>
</li>
<li>
<p>Line-comments starts with <code>#</code>. In the above case, the equivalent instructions in Dockerfile have been written out for clarity using comments.</p>
</li>
<li>
<p>Modusfile consists of a series of rules of the form <code>HEAD :- BODY.</code>, where <code>HEAD</code> is a single literal, and <code>BODY</code> is an expression involving other literals.</p>
</li>
<li>
<p>A literal has the form <code>foo(arg1, arg2, ...)</code> where <code>foo</code> is the name of the predicate, and <code>arg1</code>, <code>arg2</code>, etc. are arguments. Examples of literals in the above file are <code>my_app(&quot;debug&quot;)</code>, <code>from(&quot;rust&quot;)</code>. Literals can also have no parameters, in which case you omit the parenthesis, like <code>my_app</code>.</p>
</li>
<li>
<p>Expression uses <code>,</code> to denote logical &quot;and&quot;, and <code>;</code> to denote logical &quot;or&quot;. Expressions can be nested with <code>()</code>, and can also have &quot;<code>::</code>&quot; operators that may change the behaviour of the modified expression in some way. A later section will discuss logic in Modus in more detail, but for now just think of <code>a, b</code> as &quot;do <code>a</code> then <code>b</code>&quot;, and think of <code>a; b</code> as &quot;do either of <code>a</code> or <code>b</code>, whichever works&quot;.</p>
</li>
</ul>
<p>Note that instead of writing <code>run(&quot;cargo build&quot;)</code> directly in <code>my_app</code>, we used a custom rule <code>cargo_build</code>, which we defined later, and, when defining <code>cargo_build</code>, we have separate definition for when the argument is <code>dev</code> and when it is <code>release</code>. To make this clearer, consider the line</p>
<pre><code class="language-Modusfile">cargo_build(&quot;debug&quot;) :- run(&quot;cargo build&quot;).
</code></pre>
<p>What this means is that <code>run(&quot;cargo build&quot;)</code> logically implies <code>cargo_build(&quot;debug&quot;)</code>. Given this definition, whenever Modus sees <code>cargo_build(&quot;debug&quot;)</code>, Modus replaces it with <code>run(&quot;cargo build&quot;)</code>.</p>
<p>The <code>set_workdir</code> operator takes in a path, and sets the working directory of its image operand. This changes subsequent resolution of relative paths, such as in the destination argument of <code>copy</code>. <code>set_entrypoint</code> simply overrides the entrypoint of an image.</p>
<p>To build a Modusfile, you just need to use the &quot;<code>modus build</code>&quot; command. The usage is fairly similar to <code>docker build</code>:</p>
<pre><code>modus build [-f &lt;Modusfile&gt;] &lt;CONTEXT&gt; &lt;QUERY&gt;
</code></pre>
<p><code>CONTEXT</code> is a directory containing any source file that you want to make available to Docker, just like the context directory in <code>docker build</code>. <code>QUERY</code> is a literal denoting what you want to build. You can use &quot;<code>-f &lt;Modusfile&gt;</code>&quot; to specify the Modusfile to build, and the default is <code>Modusfile</code> in the context directory.</p>
<p>In our case, we can use <code>my_app(&quot;debug&quot;)</code> as our query in order to build a debug image. However, we can also specify unbounded variables in our query. If we simply use <code>my_app(X)</code> as our query, Modus will build two images in parallel for us, one being the debug image and the other being the release image. You can think of it as saying &quot;For all X, as long as <code>my_app(X)</code> generates a valid image, build it&quot;. You can also go a step further and add parameters to select the rust channel, base distributions, etc. You can't specify a default for these parameters, but you can define versions of <code>my_app</code> that takes different numbers (including zero) of parameters, to simulate having a default. For example, by adding:</p>
<pre><code class="language-Modusfile">my_app :- my_app(&quot;release&quot;).
</code></pre>
<p>The query <code>my_app</code> will now build the release version, while you can still use <code>my_app(&quot;debug&quot;)</code> to build the debug version.</p>
<p>The attentive reader will have noticed that our Modusfile builds both a debug and a release image. Consider how you would do this with Dockerfiles — you would either need two separate Dockerfiles, each building one version, or do something with build arguments. It may not be a problem if you only have debug and release images, but it quickly become hard to manage, especially if you need to take separate steps depending on some arguments.</p>
<h2 id="intermediate-build-stages"><a class="header" href="#intermediate-build-stages">Intermediate Build Stages</a></h2>
<p>For our next step, we want to reduce the size of the final image by building the rust code in a separate stage, then starting a new image and copying the binary inside. This can be easily implemented in Modusfile as well. We will just need to add the following lines to our existing Modusfile, and use <code>trimmed_app</code> as our query instead:</p>
<pre><code class="language-Modusfile">trimmed_app(profile) :-
  (
    from(&quot;alpine&quot;),
    my_app(profile)::copy(f&quot;target/${profile}/my_app&quot;, &quot;.&quot;)
  )::set_entrypoint(&quot;./my_app&quot;).
</code></pre>
<p><code>image::copy(source, destination)</code> is an operator that allows you to copy files from another image to the current one. The <code>image</code> here can actually be any expression generating an image, so you could also &quot;inline&quot; <code>my_app</code> and write something like:</p>
<pre><code class="language-Modusfile">trimmed_app(profile) :-
  (
    from(&quot;alpine&quot;),
    (
      from(&quot;rust:alpine&quot;)::set_workdir(&quot;/usr/src/app&quot;),
      copy(&quot;.&quot;, &quot;.&quot;),
      cargo_build(profile)
    )::copy(f&quot;target/${profile}/my_app&quot;, &quot;.&quot;)
  )::set_entrypoint(&quot;./my_app&quot;).
</code></pre>
<p>Note that both <code>source</code> and <code>destination</code> can be relative paths. They will all be resolved sensibly based on respective the working directory.</p>
<h2 id="logic-in-modus"><a class="header" href="#logic-in-modus">Logic in Modus</a></h2>
<p>Not all predicates has to be about building. Since Modus is based on a logic programming language, it goes without saying that you can write more complicated Modusfile, which can do things like figure out which version of compiler to use depeneding on constraints on parameters, or take additional steps for debug builds, etc. Here is a quick rundown of some Modus patterns:</p>
<ul>
<li>Defining multiple rules for the same predicate with different parameters. We have already seen how this lets us &quot;select&quot; what cargo command to run.</li>
<li>Creating a dictionary by defining a set of constant rules for a predicate. For example:</li>
</ul>
<pre><code class="language-Modusfile">target_cc_flags(&quot;debug&quot;, &quot;-Og -fsanitize=address,undefined&quot;).
target_cc_flags(&quot;release&quot;, &quot;-O3&quot;).
target_cc_flags(&quot;fuzz&quot;, &quot;-Og -fsanitize=fuzzer,address,undefined -DFUZZING=1&quot;).

my_app(target) :-
  ...,
  target_cc_flags(target, flags),
  run(f&quot;make CFLAGS='${flags}' CXXFLAGS='${flags}'&quot;),
  ....
</code></pre>
<p>Note that rules with no body can be written as <code>HEAD.</code>, and is always true.</p>
<ul>
<li>Defining a predicate that &quot;restricts&quot; the set of input. This is necessary to make unbounded variables work. For example:</li>
</ul>
<pre><code class="language-Modusfile">rust_channel(channel) :-
  channel = &quot;stable&quot;; channel = &quot;nightly&quot;; channel = &quot;beta&quot;.

# or

rust_channel(&quot;stable&quot;).
rust_channel(&quot;nightly&quot;).
rust_channel(&quot;beta&quot;).

my_app(channel) :-
  from(&quot;rust:alpine&quot;),
  rust_channel(channel),
  run(f&quot;rustup run ${channel} cargo build&quot;).
</code></pre>
<p>Without <code>rust_channel(channel)</code>, the query <code>my_app(X)</code> would fail, because it is not possible to build an infinite set of images. With the predicate to limit the values of <code>X</code>, a query like <code>my_app(X)</code> will build 3 images, each with a different version of rust.</p>
<h2 id="where-to-go-from-here"><a class="header" href="#where-to-go-from-here">Where to go from here…</a></h2>
<p>Now that you have learned the basics of Modus, you can go ahead and read the rest of the documentation, which dive deeper into how everything works exactly (groundness, predicate kinds, etc), as well as other built-in predicates and operators like <code>number_{gt,lt,eq,geq,leq}</code>, string parsing and manipulation, operators to set environment variables, temproarily changing the working directory with <code>in_workdir</code>, squashing image layers with <code>::merge</code>, etc.</p>
<div class="footnote-definition" id="x86_why"><sup class="footnote-definition-label">1</sup>
<p>As part of the buildkit integration Modus will fetch pre-built images from Docker Hub, and we currently only build images for x86_64. Supports for other architectures will be added in the future.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="syntax.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="syntax.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
