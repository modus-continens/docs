<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Foundations - Modus Documentation</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="tutorial.html"><strong aria-hidden="true">2.</strong> Tutorial</a></li><li class="chapter-item expanded "><a href="syntax.html"><strong aria-hidden="true">3.</strong> Syntax</a></li><li class="chapter-item expanded "><a href="semantics.html"><strong aria-hidden="true">4.</strong> Semantics</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Library</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/predicates/index.html"><strong aria-hidden="true">5.1.</strong> Predicates</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/predicates/image.html"><strong aria-hidden="true">5.1.1.</strong> Image</a></li><li class="chapter-item expanded "><a href="library/predicates/layer.html"><strong aria-hidden="true">5.1.2.</strong> Layer</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.3.</strong> Logic</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/predicates/logic/number.html"><strong aria-hidden="true">5.1.3.1.</strong> Number</a></li><li class="chapter-item expanded "><a href="library/predicates/logic/string.html"><strong aria-hidden="true">5.1.3.2.</strong> String</a></li><li class="chapter-item expanded "><a href="library/predicates/logic/semver.html"><strong aria-hidden="true">5.1.3.3.</strong> SemVer</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="library/operators/index.html"><strong aria-hidden="true">5.2.</strong> Operators</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="library/operators/image.html"><strong aria-hidden="true">5.2.1.</strong> Image</a></li><li class="chapter-item expanded "><a href="library/operators/layer.html"><strong aria-hidden="true">5.2.2.</strong> Layer</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="foundations.html" class="active"><strong aria-hidden="true">6.</strong> Foundations</a></li><li class="chapter-item expanded "><a href="cli/index.html"><strong aria-hidden="true">7.</strong> Command Line Tool</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Modus Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/modus-continens/modus" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="foundations"><a class="header" href="#foundations">Foundations</a></h1>
<p>Container images are built on top of base images by copying information from other images and intacting with the environment. Modus uses decidable logic programming to concisely capture and efficiently resolve dependencies between images and to encapluate environmental interactions with predicates and operators. This section discusses the logic programming foundations of Modus. You do not need to understand these foundations to use, and profit from, Modus.</p>
<h2 id="design-principles"><a class="header" href="#design-principles">Design Principles</a></h2>
<ul>
<li><em>Maintainability</em>: make build definitions maintainable by enabling modularity, code reuse and dependency resolution.</li>
<li><em>Efficiency</em>: make builds efficient by automatic parallelisation and fine-grained caching; provide tools for optimising the image size.</li>
<li><em>Expressiveness</em>: enable the user to express complex build workflows.</li>
<li><em>Simplicity</em>: provide minimalistic syntax and well-defined, non-Turing-complete semantics for build definitions.</li>
</ul>
<h2 id="container-image-build-model"><a class="header" href="#container-image-build-model">Container Image Build Model</a></h2>
<p>A <a href="https://opencontainers.org/">Docker/OSI container image</a> consists of a set of layers combined using a <a href="https://en.wikipedia.org/wiki/Union_mount">union mount filesystem</a>. To build an image, the user specifies the parent image and defines operations that are executed on top of the parent image to form new layers. The most common operations are copying local files into the container and executing shell commands.</p>
<p>Another important operation which enables <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage builds</a> is copying files from another image. A multi-stage build can be visualised as the following graph. Each instruction in this graph creates a new filesystem layer. Instructions are specified using Dockerfile's notation: <code>FROM</code> defines the parent image, <code>COPY</code> copies local files, <code>RUN</code> executes shell command, and <code>COPY --from</code> copies files from another container.</p>
<p><img src="build_model.svg" alt="Container Image Build Model" /></p>
<p>The key insight of Modus is that the resolution of dependencies between images in this build model maps to <a href="https://en.wikipedia.org/wiki/Horn_clause">Horn clauses</a>, logical formulas in the form \( u \leftarrow (p \wedge q\ \wedge ... \wedge\ t) \). Particularly, container images correspond to logical facts, build rules are logical rules that derive new facts from existing facts, and the build graph is a minimal proof of the fact representing the build target from the facts representing existing images.</p>
<p>Consider the following recursive build script:</p>
<pre><code class="language-Modusfile">a(mode) :-
    (
        mode = &quot;production&quot;,
        from(&quot;alpine&quot;),
        a(&quot;development&quot;)::copy(&quot;/app&quot;, &quot;/app&quot;)
    ;
        mode = &quot;development&quot;,
        from(&quot;gcc&quot;),
        copy(&quot;.&quot;, &quot;/app&quot;),
        run(&quot;cd /app &amp;&amp; make&quot;)
    )::set_workdir(&quot;/app&quot;).
</code></pre>
<p>For the query <code>a(X)</code>, where <code>X</code> is a variable, Modus computes the following build trees:</p>
<pre><code>a(&quot;production&quot;)
╞══ from(&quot;alpine&quot;)
└── a(&quot;development&quot;)::copy(&quot;/app&quot;, &quot;/app&quot;)
    ╞══ from(&quot;gcc&quot;)
    ├── copy(&quot;.&quot;, &quot;/app&quot;)
    └── run(&quot;cd /app &amp;&amp; make&quot;)
a(&quot;development&quot;)
╞══ from(&quot;gcc&quot;)
├── copy(&quot;.&quot;, &quot;/app&quot;)
└── run(&quot;cd /app &amp;&amp; make&quot;)
</code></pre>
<p>The subtree <code>a(&quot;development&quot;)</code> of the two trees is shared; it is only built once.</p>
<h2 id="datalog"><a class="header" href="#datalog">Datalog</a></h2>
<p>Datalog is a decidable fragment of Horn clauses. A good overview of Datalog is given in the following article:</p>
<p><em><a href="https://ieeexplore.ieee.org/document/43410">What You Always Wanted to Know About Datalog (And Never Dared to Ask)</a></em><br>
Stefano Ceri, Georg Gottlob, Letizia Tanca<br>
IEEE TKDE 1989</p>
<p>Modus uses Datalog because it is:</p>
<ul>
<li>declarative, the success of solving does not depend on the ordering of clauses;</li>
<li>expressive;</li>
<li>decidable, so it can always generate a minimal proof.</li>
</ul>
<p>Thus, Datalog presents a sweet spot between expressiveness and computatibility, which is important for a build system. Standard Datalog, despite its suitability for addressing their core dependency resolution problem, does not capture a container build environmental dependencies. To solve this problem, Modus extends Datalog with build-specific predicates and build parameters via ungrounded variables. Modus supports two Datalog extensions, namely builtin predicates described in <a href="./library/predicates/">Predicates</a> and non-grounded variables. To realise these extensions, Modus uses a custom top-down Datalog solver for generating proofs.</p>
<h3 id="builtin-predicates"><a class="header" href="#builtin-predicates">Builtin Predicates</a></h3>
<p>Dependency resolution is only part of the story. Container builds must also interact with the environment. Predicates elegantly capture these interactions. We have equipped Modus with a library of built-in predicates to handle these interactions. For example, the <code>semver_*</code> predicates define software version comparison as per the (SemVer)[https://semver.org/] specification.  For example, the following fact is true: <code>semver_lt(&quot;1.0.3&quot;,&quot;1.1.0&quot;)</code>, where <code>lt</code> means <code>&lt;</code>.</p>
<p>The key difficulty of adding built-in predicates to Datalog is that built-in predicates such as <code>semver_lt</code> are infinite relations, which require special handling to retain Datalog's decidability. We support built-in predicates by deferring the evaluation of a built-in predicate until the arguments of this predicate are bound to constants.</p>
<p>Since not all arguments of a predicate have to be bound to a constant during evaluation, e.g. if an argument depends on the other arguments, builtin predicates in Modus have Prolog-like signatures that specify which parameters have to be initialised (see <a href="./library/predicates/index.html">Predicates</a>). <!-- FIXME: https://github.com/rust-lang/mdBook/issues/984 --></p>
<h3 id="non-grounded-variables"><a class="header" href="#non-grounded-variables">Non-Grounded Variables</a></h3>
<p>Build systems often use parameters that are passed by the user when they launch a build. Dockerfiles allow users to specify arbitrary parameters when launching a target's build using the <code>--build-arg</code> option. For example, a user may want to parameretise <code>app</code>'s image build with the parameter <code>cflags</code> to control complation flags:</p>
<pre><code class="language-Modusfile">app(cflags) :-
  from(&quot;gcc:latest&quot;),
  copy(&quot;.&quot;, &quot;.&quot;),
  run(f&quot;gcc ${cflags} test.c -o test&quot;).
</code></pre>
<p>In this rule, the variable <code>cflags</code> is not <em>grounded</em>, as it only appears as an argument of a built-in predicate <code>run</code> that expects an instantiated variable. Thus, this is an invalid Datalog program, since it violates standard Datalog's safety conditions that do not permit non-grounded variables. A workaround of this problem is to define possible compilation flags using a dedicated predicate:</p>
<pre><code class="language-Modusfile">supported_flags(&quot;-g&quot;).
supported_flags(&quot;&quot;).

a(cflags) :-
    supported_flags(cflags),
    from(&quot;gcc:latest&quot;),
    copy(&quot;.&quot;, &quot;.&quot;),
    run(f&quot;gcc ${cflags} test.c -o test&quot;).
</code></pre>
<p>However, GCC accepts a large number of flags, so it would impractical to list all accepted flags in the Modus program. Instead, it would be natural to allow users to use this program to build the goal <code>app(&quot;-g&quot;)</code>, since the argument of <code>run</code> can then be inferred from the goal.</p>
<p>To enable such usage scenarios, we relaxed the safety conditions by allowing user-defined predicates with non-grounded variables. At the same time, we introduced the new restriction that, during evaluation, we defer the evaluation of these predicates until all of their arguments are bound to constants. Doing so enabled us to support the usage scenario above without sacrificing Datalog's safety.</p>
<p>For user-defined predicates, variables which do not appear in the body have to be initialised before the rule can be applied. For example, for the script:</p>
<pre><code class="language-Modusfile">a(X) :-
  from(&quot;alpine&quot;),
  run(&quot;echo Hello&quot;).
</code></pre>
<p>A query like <code>a(&quot;foo&quot;)</code>, where <code>&quot;foo&quot;</code> is a arbitrary string constant, would build the same image, but the query <code>a(X)</code> is not allowed. This ensures that each resulting image is mapped to a constant literal like <code>a(&quot;foo&quot;)</code>.</p>
<h3 id="proof-optimality"><a class="header" href="#proof-optimality">Proof Optimality</a></h3>
<p>A Datalog fact can be inferred from other facts in multiple ways and therefore multiple proof trees may exists. Thus, an image defined in Modus may also be built using different build DAGs. Modus searches for an optimal proof, that is a proof with a minimal cost. The cost of a proof is the number of layers in the build DAG.</p>
<p>To illustrate proof optimality, consider again this build script:</p>
<pre><code class="language-Modusfile">a(mode) :-
    (
        mode = &quot;production&quot;,
        from(&quot;alpine&quot;),
        a(&quot;development&quot;)::copy(&quot;/app&quot;, &quot;/app&quot;)
    ;
        mode = &quot;development&quot;,
        from(&quot;gcc&quot;),
        copy(&quot;.&quot;, &quot;/app&quot;),
        run(&quot;cd /app &amp;&amp; make&quot;)
    )::set_workdir(&quot;/app&quot;).
</code></pre>
<p>For the query <code>a(&quot;production&quot;)</code>, Modus will compute the following build trees:</p>
<pre><code>a(&quot;production&quot;)
╞══ from(&quot;alpine&quot;)
└── a(&quot;development&quot;)::copy(&quot;/app&quot;, &quot;/app&quot;)
    ╞══ from(&quot;gcc&quot;)
    ├── copy(&quot;.&quot;, &quot;/app&quot;)
    └── run(&quot;cd /app &amp;&amp; make&quot;)
</code></pre>
<p>However, if we add a new rule that uses a cached development image from a registry</p>
<pre><code class="language-Modusfile">a(&quot;development&quot;) :- from(&quot;myregistry.domain.com/app:1.1-dev&quot;).
</code></pre>
<p>then the result of the query <code>a(&quot;production&quot;)</code> will become</p>
<pre><code>a(&quot;production&quot;)
╞══ from(&quot;alpine&quot;)
└── a(&quot;development&quot;)::copy(&quot;/app&quot;, &quot;/app&quot;)
    ╘══ from(&quot;myregistry.domain.com/app:1.1-dev&quot;)
</code></pre>
<p>because this tree involves fewer layer operations than the original one.</p>
<p>There may be situations when several minimal proofs of the same cost exist. In this case, Modus chooses one in an unspecified way. Although Modus is deterministic, reordering rules may cause Modus to generate a different minimal proof. To avoid non-determinism, it is recommend to avoid rules with uncontrolled choice:</p>
<pre><code class="language-Modusfile">a :- b; c.
</code></pre>
<p>Instead, this rule can be re-written with an auxiliary variable to control the choice:</p>
<pre><code class="language-Modusfile">a(choice) :-
    choice = &quot;left&quot;, b;
    choice = &quot;right&quot;, c.
</code></pre>
<p>Modus produces a warning when the build graph construction is non-deterministic.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="library/operators/layer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="cli/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="library/operators/layer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="cli/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
